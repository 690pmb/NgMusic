<!-- Compositions Filters -->
<div class="parent-filter filters">
  <div>
    <div class="filters">
      <app-filter-input
        [control]="filters.controls.artist"
        placeholder="Chercher un artiste"
      ></app-filter-input>
      <app-filter-input
        [control]="filters.controls.title"
        placeholder="Chercher un titre"
      ></app-filter-input>
      <app-filter-select
        placeholder="Type"
        [control]="filters.controls.type"
        [options]="types"
      ></app-filter-select>
      <!-- Delete filter -->
      <span class="filter-deleted">
        <div>Supprimé:</div>
        <mat-checkbox [formControl]="filters.controls.deleted"> </mat-checkbox>
      </span>
    </div>
    <!-- Fichier Filters -->
    <div class="filters">
      <app-filter-input
        [control]="filters.controls.filename"
        placeholder="Chercher un fichier"
      ></app-filter-input>
      <app-filter-select
        placeholder="Catégorie"
        [control]="filters.controls.category"
        [options]="catList"
        [multiple]="true"
      ></app-filter-select>
      <app-filter-year
        [control]="filters.controls.begin"
        placeholder="Année de début"
      ></app-filter-year>
      <app-filter-year
        [control]="filters.controls.end"
        placeholder="Année de fin"
      ></app-filter-year>
    </div>
    <div
      *ngIf="
    filters.errors?.['invalidYears'] &&
    (filters.touched || filters.dirty)
  "
      class="mat-mdc-form-field-error years-error"
    >
      L'année de fin doit être supérieure à l'année de début
    </div>
  </div>
  <fa-icon
    class="reset-btn pointer"
    [icon]="['fas', 'rotate-right']"
    size="3x"
    (click)="filters.reset()"
    matRipple
    [matRippleRadius]="35"
    [matRippleCentered]="true"
    matRippleColor="var(--purple)"
    matRippleUnbounded="true"
    matRippleUnbounded="false"
  ></fa-icon>
</div>
<div class="paginator mat-elevation-z4">
  <!-- Paginator -->
  <mat-paginator
    #paginator
    [length]="length"
    [pageIndex]="0"
    [pageSize]="50"
    [pageSizeOptions]="pageSizeOptions"
    (page)="page = $event; onPaginateChange()"
    [showFirstLastButtons]="true"
  >
  </mat-paginator>
</div>

<!-- Table -->
<mat-table
  class="mat-elevation-z4"
  [dataSource]="displayedData"
  (matSortChange)="paginator.firstPage(); sort = $event; onSort()"
  matSort
  [matSortActive]="'score'"
  [matSortDirection]="'desc'"
  multiTemplateDataRows
>
  <!-- ARTIST -->
  <ng-container matColumnDef="artist">
    <mat-header-cell *matHeaderCellDef mat-sort-header>
      <span class="mat-text">Artiste</span>
    </mat-header-cell>
    <mat-cell *matCellDef="let compo">
      {{ compo.artist }}
    </mat-cell>
  </ng-container>

  <!-- TITLE -->
  <ng-container matColumnDef="title">
    <mat-header-cell *matHeaderCellDef mat-sort-header>
      <span class="mat-text">Titre</span>
    </mat-header-cell>
    <mat-cell *matCellDef="let compo">
      {{ compo.title }}
    </mat-cell>
  </ng-container>

  <!-- TYPE -->
  <ng-container matColumnDef="type">
    <mat-header-cell *matHeaderCellDef mat-sort-header>
      <span class="mat-text">Type</span>
    </mat-header-cell>
    <mat-cell *matCellDef="let compo">
      {{ compo.type | title }}
    </mat-cell>
  </ng-container>

  <!-- SIZE -->
  <ng-container matColumnDef="sizeC">
    <mat-header-cell *matHeaderCellDef mat-sort-header>
      <span class="mat-text">Taille</span>
    </mat-header-cell>
    <mat-cell *matCellDef="let compo">
      {{ compo.displayedFileList.length }}
    </mat-cell>
  </ng-container>

  <!-- SCORE -->
  <ng-container matColumnDef="score">
    <mat-header-cell *matHeaderCellDef mat-sort-header>
      <span class="mat-text">Score</span>
    </mat-header-cell>
    <mat-cell *matCellDef="let compo">
      {{ compo.score | number: '1.0-0':'fr' }}
      <div class="decile-{{ compo.decile }}">({{ compo.decile }})</div>
    </mat-cell>
  </ng-container>

  <!-- MENU -->
  <ng-container matColumnDef="menu">
    <mat-header-cell *matHeaderCellDef>
      <span class="mat-text">Menu</span>
    </mat-header-cell>
    <mat-cell *matCellDef="let compo">
      <app-row-menu [composition]="compo"></app-row-menu>
    </mat-cell>
  </ng-container>

  <!-- Fichier -->
  <ng-container matColumnDef="{{ expandedColumn }}">
    <td
      mat-cell
      *matCellDef="let compo"
      [attr.colspan]="displayedColumnsComposition.length"
      [@detailExpand]="compo == expandedElement ? 'expanded' : 'collapsed'"
    >
      <div class="example-element-detail">
        <mat-table
          [dataSource]="displayedFichier"
          *ngIf="compo == expandedElement"
          matSort
          [matSortActive]="'rank'"
          [matSortDirection]="'desc'"
          (matSortChange)="onSortFichier($event)"
        >
          <div *ngFor="let column of displayedColumnsFichier">
            <ng-container matColumnDef="{{ column }}">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                <span class="mat-text">{{ column | upperFirst }}</span>
              </mat-header-cell>
              <mat-cell *matCellDef="let fichier">
                {{ fichier[column] | title: true }}
              </mat-cell>
            </ng-container>
          </div>
          <mat-header-row
            *matHeaderRowDef="displayedColumnsFichier"
          ></mat-header-row>
          <mat-row
            *matRowDef="let fileRow; columns: displayedColumnsFichier"
            [ngClass]="{sorted: fileRow.sorted === 1}"
          >
          </mat-row>
        </mat-table>
      </div>
    </td>
  </ng-container>

  <mat-header-row
    *matHeaderRowDef="displayedColumnsComposition"
  ></mat-header-row>
  <mat-row
    *matRowDef="
      let element;
      let i = dataIndex;
      columns: displayedColumnsComposition
    "
    [appRowAction]="element"
    [isMobile]="!isDesktop"
    class="example-element-row"
    [ngClass]="{
      deleted: element.deleted === 1,
      even: i % 2 === 0,
      odd: i % 2 === 1
    }"
    [class.example-expanded-row]="expandedElement === element"
    (click)="expand(element)"
  >
  </mat-row>
  <mat-row
    *matRowDef="let row; let i = dataIndex; columns: [expandedColumn]"
    class="example-detail-row"
    [ngClass]="{
      deleted: row.deleted === 1,
      even: i % 2 === 0,
      odd: i % 2 === 1
    }"
  ></mat-row>
</mat-table>

<app-go-to-top></app-go-to-top>
